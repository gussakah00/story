"use strict";(self.webpackChunkcerita_di_sekitarmu=self.webpackChunkcerita_di_sekitarmu||[]).push([[611],{188:(e,t,a)=>{a.d(t,{DY:()=>l,Lx:()=>s,ZO:()=>o,y_:()=>r});var i=a(763);const n="https://story-api.dicoding.dev/v1";async function o(){const e=i.y.getToken();if(!e)return console.log("User belum login, tidak bisa mengambil data stories"),[];try{console.log("ðŸ” DEBUG - Fetching stories from API...");const t=new AbortController,a=setTimeout((()=>t.abort()),1e4),i=await fetch(`${n}/stories`,{headers:{Authorization:`Bearer ${e}`},signal:t.signal});if(clearTimeout(a),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=await i.json();return console.log("ðŸ” DEBUG - Full API Response:",o),o.error||!o.listStory?(console.error("API returned error:",o.message),[]):o.listStory.map((e=>{let t=e.photoUrl;return e.photoUrl&&e.photoUrl.startsWith("http")||(t="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWJhciB0aWRhayB0ZXJzZWRpYTwvdGV4dD48L3N2Zz4="),{id:e.id,name:e.name,description:e.description,photoUrl:t,lat:e.lat,lon:e.lon,createdAt:e.createdAt}}))}catch(e){return console.error("âŒ Error fetching stories:",e),"AbortError"===e.name?console.error("Request timeout - API server mungkin lambat"):"TypeError"===e.name&&e.message.includes("Failed to fetch")&&console.error("Network error - Tidak bisa connect ke API server"),[]}}async function r({description:e,photo:t,lat:a,lon:o}){const r=i.y.getToken();if(!r)return{error:!0,message:"Anda harus login untuk menambah cerita."};const s=new FormData;s.append("description",e),s.append("photo",t),a&&s.append("lat",a),o&&s.append("lon",o);try{console.log("ðŸ” DEBUG - Mulai mengirim cerita ke API...");const e=new AbortController,t=setTimeout((()=>e.abort()),3e4),a=await fetch(`${n}/stories`,{method:"POST",body:s,headers:{Authorization:`Bearer ${r}`},signal:e.signal});clearTimeout(t),console.log("ðŸ” DEBUG - Response status:",a.status);const i=await a.json();return console.log("ðŸ” DEBUG - Response data:",i),!a.ok||i.error?{error:!0,message:i.message||`Error ${a.status}: ${a.statusText}`}:(console.log("ðŸ” DEBUG - Cerita berhasil dikirim:",i),i)}catch(e){return console.error("ðŸ” DEBUG - Error detail:",e),"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:"TypeError"===e.name&&e.message.includes("Failed to fetch")?{error:!0,message:"Gagal terhubung ke server. Periksa koneksi internet Anda."}:{error:!0,message:`Gagal mengirim data: ${e.message}`}}}async function s({email:e,password:t}){try{const a=new AbortController,i=setTimeout((()=>a.abort()),1e4),o=await fetch(`${n}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t}),signal:a.signal});clearTimeout(i);const r=await o.json();return o.ok?{error:!1,data:r}:{error:!0,message:r.message||"Login gagal"}}catch(e){return"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:{error:!0,message:"Terjadi kesalahan jaringan"}}}async function l({name:e,email:t,password:a}){try{const i=new AbortController,o=setTimeout((()=>i.abort()),1e4),r=await fetch(`${n}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:a}),signal:i.signal});clearTimeout(o);const s=await r.json();return r.ok?{error:!1,data:s}:{error:!0,message:s.message||"Pendaftaran gagal"}}catch(e){return"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:{error:!0,message:"Terjadi kesalahan jaringan"}}}},611:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});var i=a(188),n=a(763);const o={_map:null,_marker:null,_latitude:null,_longitude:null,_stream:null,_capturedBlob:null,_isInitialized:!1,_markIcon:L.icon({iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),render:async()=>n.y.isLoggedIn()?'\n      <section class="add-story" aria-labelledby="add-title">\n        <h1 id="add-title" tabindex="0">Tambah Cerita Baru</h1>\n        <div class="form-container">\n          <form id="addStoryForm" aria-labelledby="add-title">\n            <p id="form-message" class="info-message" aria-live="polite" style="display:none;"></p>\n\n            \x3c!-- Map Picker --\x3e\n            <div class="form-section">\n              <h2>Pilih Lokasi Cerita</h2>\n              <p class="form-help">Klik pada peta untuk memilih lokasi cerita Anda (opsional)</p>\n              <div id="map-picker" style="height: 300px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;" \n                   aria-label="Peta untuk memilih lokasi cerita">\n                <div style="text-align: center; padding: 40px; color: #666;">\n                  <p>Memuat peta...</p>\n                </div>\n              </div>\n              \n              <div class="coordinates-display">\n                <div class="coordinate-field">\n                  <label for="latitude">Latitude:</label>\n                  <input type="text" id="latitude" name="lat" readonly aria-label="Latitude lokasi yang dipilih">\n                </div>\n                <div class="coordinate-field">\n                  <label for="longitude">Longitude:</label>\n                  <input type="text" id="longitude" name="lon" readonly aria-label="Longitude lokasi yang dipilih">\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- Story Details --\x3e\n            <div class="form-section">\n              <h2>Detail Cerita</h2>\n              \n              <div class="form-group">\n                <label for="title">Judul Cerita:</label>\n                <input type="text" id="title" name="title" required aria-required="true" \n                       placeholder="Masukkan judul cerita Anda" aria-describedby="title-help">\n                <p id="title-help" class="form-help">Beri judul yang menarik untuk cerita Anda</p>\n                <p id="title-error" class="error-message" style="display:none;" aria-live="polite"></p>\n              </div>\n\n              <div class="form-group">\n                <label for="description">Deskripsi Cerita:</label>\n                <textarea id="description" name="description" required aria-required="true" \n                          placeholder="Tuliskan isi cerita Anda di sini..." \n                          rows="5" aria-describedby="description-help"></textarea>\n                <p id="description-help" class="form-help">Ceritakan pengalaman atau momen spesial Anda</p>\n                <p id="description-error" class="error-message" style="display:none;" aria-live="polite"></p>\n              </div>\n            </div>\n\n            \x3c!-- Photo Upload --\x3e\n            <div class="form-section">\n              <h2>Foto Cerita</h2>\n              \n              <div class="form-group">\n                <label for="photoType">Pilih Sumber Gambar:</label>\n                <select id="photoType" name="photoType" aria-describedby="photoType-help">\n                  <option value="file">Upload File Gambar</option>\n                  <option value="camera">Ambil dari Kamera</option>\n                </select>\n                <p id="photoType-help" class="form-help">Pilih cara untuk menambahkan foto cerita</p>\n              </div>\n\n              <div id="fileUploadContainer" class="upload-section">\n                <label for="photo">Upload Foto:</label>\n                <input type="file" id="photo" name="photo" accept="image/*" required aria-required="true"\n                       aria-describedby="photo-help">\n                <p id="photo-help" class="form-help">Format: JPG, PNG, GIF. Maksimal 5MB</p>\n                <div id="filePreview" class="image-preview" style="display:none;">\n                  <img id="filePreviewImage" src="#" alt="Pratinjau gambar yang diupload" style="max-width: 100%; max-height: 200px;">\n                </div>\n              </div>\n\n              <div id="cameraContainer" class="upload-section" style="display:none;">\n                <div class="camera-controls">\n                  <video id="videoElement" width="320" height="240" autoplay \n                         aria-label="Pratinjau kamera" style="border-radius: 8px;"></video>\n                  <canvas id="canvasElement" width="320" height="240" style="display:none;"></canvas>\n                  \n                  <div class="camera-buttons">\n                    <button type="button" id="captureButton" class="secondary-button">Ambil Foto</button>\n                    <button type="button" id="retakeButton" class="secondary-button" style="display:none;">Ambil Ulang</button>\n                  </div>\n                </div>\n                \n                <p id="camera-status" class="info-message" aria-live="polite" style="display:none;"></p>\n                \n                <div id="capturedImagePreview" class="image-preview" style="display:none;">\n                  <img id="capturedPreviewImage" src="#" alt="Pratinjau foto yang diambil" style="max-width: 100%; max-height: 200px;">\n                  <p class="form-help">Foto berhasil diambil! Klik "Ambil Ulang" jika ingin mengganti.</p>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- Submit Button --\x3e\n            <div class="form-actions">\n              <button type="submit" id="submitButton" class="primary-button">\n                Kirim Cerita\n              </button>\n              <button type="button" id="cancelButton" class="secondary-button">\n                Batal\n              </button>\n            </div>\n          </form>\n        </div>\n      </section>\n    ':'\n        <section class="add-story" aria-labelledby="add-title">\n          <h1 id="add-title" tabindex="0">Akses Ditolak</h1>\n          <div style="text-align: center; padding: 40px;">\n            <p>Anda harus login untuk menambah cerita.</p>\n            <a href="#/login" class="link">Masuk</a> atau \n            <a href="#/register" class="link">Daftar akun baru</a>\n          </div>\n        </section>\n      ',async afterRender(){if(n.y.isLoggedIn()){this._isInitialized=!1,await new Promise((e=>setTimeout(e,200)));try{await this._initMap(),this._setupFormInteractivity(),this._isInitialized=!0}catch(e){console.error("Error in afterRender:",e)}}},async _initMap(){return new Promise(((e,t)=>{setTimeout((()=>{try{if(!document.getElementById("map-picker"))return console.error("Map container #map-picker not found"),void t(new Error("Map container not found"));if("undefined"==typeof L)return console.error("Leaflet not loaded"),void t(new Error("Leaflet library not found"));this._map&&(this._map.remove(),this._map=null),this._map=L.map("map-picker").setView([-6.2,106.8],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(this._map),this._map.on("click",(e=>this._onMapClick(e))),this._marker=L.marker([-6.2,106.8],{icon:this._markIcon}).addTo(this._map).bindPopup("Lokasi default: Jakarta").openPopup(),this._latitude="-6.200000",this._longitude="106.800000";const a=document.getElementById("latitude"),i=document.getElementById("longitude");a&&(a.value=this._latitude),i&&(i.value=this._longitude),setTimeout((()=>{this._map&&this._map.invalidateSize()}),100),console.log("Map initialized successfully"),e()}catch(e){console.error("Error initializing map:",e);const a=document.getElementById("map-picker");a&&(a.innerHTML=`\n              <div style="text-align: center; padding: 40px; color: #666;">\n                <p>Gagal memuat peta. Pastikan koneksi internet Anda stabil.</p>\n                <p style="font-size: 12px; margin-top: 10px;">Error: ${e.message}</p>\n              </div>\n            `),t(e)}}),100)}))},_onMapClick(e){if(!this._map||!this._marker)return;this._marker&&this._map.removeLayer(this._marker),this._latitude=e.latlng.lat.toFixed(6),this._longitude=e.latlng.lng.toFixed(6),this._marker=L.marker([this._latitude,this._longitude],{icon:this._markIcon}).addTo(this._map).bindPopup(`Lokasi terpilih: ${this._latitude}, ${this._longitude}`).openPopup();const t=document.getElementById("latitude"),a=document.getElementById("longitude");t&&(t.value=this._latitude),a&&(a.value=this._longitude)},_setupFormInteractivity(){setTimeout((()=>{const e=document.getElementById("addStoryForm");if(!e)return void console.error("Form not found");const t=document.getElementById("photoType"),a=document.getElementById("fileUploadContainer"),n=document.getElementById("cameraContainer"),o=document.getElementById("videoElement"),r=document.getElementById("canvasElement"),s=document.getElementById("captureButton"),l=document.getElementById("retakeButton"),d=document.getElementById("filePreview"),c=document.getElementById("filePreviewImage"),m=document.getElementById("capturedImagePreview"),p=document.getElementById("capturedPreviewImage"),u=document.getElementById("photo"),g=document.getElementById("form-message"),h=document.getElementById("cancelButton");if(!(t&&a&&n&&o&&r&&s&&l&&d&&c&&m&&p&&u&&g&&h))return void console.error("Some form elements not found");let y=null;const b=()=>{this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,o.srcObject=null)};u.addEventListener("change",(e=>{const t=e.target.files[0];if(t){if(t.size>5242880)return g.textContent="Ukuran file terlalu besar. Maksimal 5MB.",g.style.backgroundColor="#fee",g.style.display="block",void(u.value="");const e=new FileReader;e.onload=e=>{c.src=e.target.result,d.style.display="block"},e.readAsDataURL(t)}})),t.addEventListener("change",(async e=>{const t=e.target.value;if(y=null,m.style.display="none",d.style.display="none",u.required="file"===t,"camera"===t){a.style.display="none",n.style.display="block",l.style.display="none",s.style.display="block";try{this._stream=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240}}),o.srcObject=this._stream;const e=document.getElementById("camera-status");e&&(e.textContent="Kamera aktif. Silakan ambil foto.",e.style.display="block",e.style.backgroundColor="#e8f5e8")}catch(e){console.error("Gagal mengakses kamera: ",e);const t=document.getElementById("camera-status");t&&(t.textContent="Gagal mengakses kamera. Periksa izin perangkat Anda.",t.style.backgroundColor="#fee",t.style.display="block"),b()}}else{b(),n.style.display="none",a.style.display="block";const e=document.getElementById("camera-status");e&&(e.style.display="none")}})),s.addEventListener("click",(()=>{if(this._stream){const e=r.getContext("2d");r.width=o.videoWidth,r.height=o.videoHeight,e.drawImage(o,0,0,r.width,r.height),r.toBlob((e=>{y=new File([e],"story-photo.png",{type:"image/png"}),this._capturedBlob=y,p.src=URL.createObjectURL(e),m.style.display="block",l.style.display="block",s.style.display="none";const t=document.getElementById("camera-status");t&&(t.textContent="Foto berhasil diambil!",t.style.backgroundColor="#e8f5e8"),b()}),"image/png")}})),l.addEventListener("click",(async()=>{m.style.display="none",l.style.display="none",s.style.display="block",y=null,this._capturedBlob=null;try{this._stream=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240}}),o.srcObject=this._stream;const e=document.getElementById("camera-status");e&&(e.textContent="Kamera aktif. Silakan ambil foto.",e.style.backgroundColor="#e8f5e8")}catch(e){console.error("Gagal mengakses kamera: ",e);const t=document.getElementById("camera-status");t&&(t.textContent="Gagal mengakses kamera.",t.style.backgroundColor="#fee")}})),h.addEventListener("click",(()=>{confirm("Apakah Anda yakin ingin membatalkan? Data yang sudah diisi akan hilang.")&&(b(),window.location.hash="#/beranda")})),this._closeMediaStream=b,e.addEventListener("submit",(async a=>{if(a.preventDefault(),g.style.display="none",!this._validateForm(e))return g.textContent="Mohon periksa input Anda. Pastikan semua field wajib diisi dengan benar.",g.style.backgroundColor="#fee",void(g.style.display="block");const n=new FormData(e);let o=null;if("camera"===t.value&&this._capturedBlob)o=this._capturedBlob;else{if("file"!==t.value||!u.files[0])return g.textContent="Mohon pilih atau ambil foto.",g.style.backgroundColor="#fee",void(g.style.display="block");o=u.files[0]}console.log("ðŸ” DEBUG - Data yang akan dikirim:",{description:`**${n.get("title").trim()}**\n${n.get("description").trim()}`,photo:o,lat:this._latitude,lon:this._longitude,photoSize:o.size,photoType:o.type});const r={description:`**${n.get("title").trim()}**\n${n.get("description").trim()}`,photo:o,lat:this._latitude?parseFloat(this._latitude):null,lon:this._longitude?parseFloat(this._longitude):null},s=document.getElementById("submitButton");s.disabled=!0,s.innerHTML="Mengirim...",g.textContent="Mengirim cerita Anda...",g.style.backgroundColor="#e3f2fd",g.style.display="block";try{console.log("ðŸ” DEBUG - Memanggil postStory...");const e=await(0,i.y_)(r);if(console.log("ðŸ” DEBUG - Response dari postStory:",e),e.error)throw new Error(e.message||"Gagal mengirim data ke API.");g.textContent="Cerita berhasil ditambahkan! Mengarahkan ke Beranda...",g.style.backgroundColor="#e8f5e8",b(),setTimeout((()=>{window.location.hash="#/beranda"}),2e3)}catch(e){console.error("Error posting story:",e),g.textContent=`Gagal mengirim cerita: ${e.message}`,g.style.backgroundColor="#fee",s.disabled=!1,s.innerHTML="Kirim Cerita"}}))}),100)},_validateForm(e){let t=!0;const a=e.querySelector("#title"),i=e.querySelector("#description"),n=e.querySelector("#photoType"),o=e.querySelector("#photo"),r=document.querySelector("#title-error"),s=document.querySelector("#description-error");r&&(r.style.display="none",r.textContent=""),s&&(s.style.display="none",s.textContent=""),a.setCustomValidity(""),i.setCustomValidity("");const l=a.value.trim();l?l.length<2&&(r&&(r.textContent="Judul minimal 2 karakter.",r.style.display="block"),t=!1):(r&&(r.textContent="Judul cerita wajib diisi.",r.style.display="block"),t=!1);const d=i.value.trim();d?d.length<5&&(s&&(s.textContent="Deskripsi minimal 5 karakter.",s.style.display="block"),t=!1):(s&&(s.textContent="Deskripsi cerita wajib diisi.",s.style.display="block"),t=!1);const c=n.value;return"file"===c?o.files&&o.files[0]||(t=!1):"camera"===c&&(this._capturedBlob||(t=!1)),t},cleanup(){console.log("AddPage: Cleaning up..."),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null),this._map&&(this._map.remove(),this._map=null),this._marker=null,this._capturedBlob=null,this._isInitialized=!1,this._closeMediaStream&&window.removeEventListener("hashchange",this._closeMediaStream)}}}}]);