"use strict";(self.webpackChunkcerita_di_sekitarmu=self.webpackChunkcerita_di_sekitarmu||[]).push([[451],{426:(e,t,n)=>{n.d(t,{v:()=>r});const r=new class{constructor(){this.dbName="CeritaDatabase",this.version=9,this.db=null,this._isOpening=!1,this._openPromise=null}async init(){return this._isOpening||(this._isOpening=!0,this._openPromise=new Promise(((e,t)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>{this._isOpening=!1,t(n.error)},n.onsuccess=()=>{this.db=n.result,this._isOpening=!1,this.db.onerror=e=>{console.error("Database error:",e.target.error)},this.db.onclose=()=>{console.log("Database connection closed"),this.db=null,this._isOpening=!1},e(this.db)},n.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion;if(console.log(`üîÑ Database upgrading from version ${n} to ${this.version}`),n<1){const e=t.createObjectStore("stories",{keyPath:"id"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("hasLocation","hasLocation",{unique:!1}),e.createIndex("name","name",{unique:!1}),e.createIndex("description","description",{unique:!1});const n=t.createObjectStore("offlineStories",{keyPath:"id",autoIncrement:!0});n.createIndex("createdAt","createdAt",{unique:!1}),n.createIndex("synced","synced",{unique:!1}),t.createObjectStore("favorites",{keyPath:"storyId"}).createIndex("addedAt","addedAt",{unique:!1})}if(n<9){const t=e.target.transaction.objectStore("offlineStories");t.indexNames.contains("synced")||t.createIndex("synced","synced",{unique:!1})}},n.onblocked=()=>{console.log("‚ö†Ô∏è Database upgrade blocked - close other tabs"),this.db&&this.db.close()}}))),this._openPromise}async _ensureDB(){if(this.db)try{const e=this.db.transaction([],"readonly");await new Promise(((t,n)=>{e.oncomplete=t,e.onerror=n}))}catch(e){console.log("Database connection lost, reinitializing..."),this.db=null,await this.init()}else await this.init()}async saveStories(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["stories"],"readwrite"),s=r.objectStore("stories");s.clear(),e.forEach((e=>{s.put({...e,hasLocation:!(!e.lat||!e.lon),cachedAt:(new Date).toISOString()})})),r.oncomplete=()=>t(),r.onerror=()=>n(r.error)}))}catch(e){throw console.error("Error saving stories:",e),e}}async getStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const n=this.db.transaction(["stories"],"readonly").objectStore("stories").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>t(n.error)}))}catch(e){return console.error("Error getting stories:",e),[]}}async deleteStory(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["stories"],"readwrite").objectStore("stories").delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)}))}catch(e){throw console.error("Error deleting story:",e),e}}async saveOfflineStory(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories"),s={...e,id:Date.now(),createdAt:(new Date).toISOString(),synced:!1},o=r.add(s);o.onsuccess=()=>t(s.id),o.onerror=()=>n(o.error)}))}catch(e){throw console.error("Error saving offline story:",e),e}}async getOfflineStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const n=this.db.transaction(["offlineStories"],"readonly").objectStore("offlineStories").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>t(n.error)}))}catch(e){return console.error("Error getting offline stories:",e),[]}}async deleteOfflineStory(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories").delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)}))}catch(e){throw console.error("Error deleting offline story:",e),e}}async markOfflineStoryAsSynced(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories"),s=r.get(e);s.onsuccess=()=>{const o=s.result;if(o){const s="string"==typeof e?parseInt(e):e;o.synced=!0,o.id=s;const a=r.put(o);a.onsuccess=()=>{console.log(`Story ${e} marked as synced`),t()},a.onerror=t=>{console.error(`Error marking story ${e} as synced:`,t),n(t)}}else console.warn(`Story ${e} not found for marking as synced`),t()},s.onerror=t=>{console.error(`Error getting story ${e}:`,t),n(t)}}))}catch(e){throw console.error("Error marking story as synced:",e),e}}async getUnsyncedStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const n=this.db.transaction(["offlineStories"],"readonly").objectStore("offlineStories").getAll();n.onsuccess=()=>{try{const t=n.result||[];console.log("Total offline stories:",t.length);const r=t.filter((e=>!1===e.synced||void 0===e.synced));console.log("Unsynced stories:",r.length),e(r)}catch(t){console.error("Error filtering stories:",t),e([])}},n.onerror=e=>{console.error("Error getting offline stories:",e),t(e)}}))}catch(e){return console.error("Error in getUnsyncedStories:",e),[]}}async syncOfflineStories(){try{console.log("Starting offline stories sync...");const e=await this.getUnsyncedStories();console.log(`Found ${e.length} stories to sync`);const t={successful:[],failed:[]};if(0===e.length)return console.log("No stories to sync"),t;for(const n of e)try{console.log(`Syncing story ${n.id}...`),await new Promise(((e,t)=>{setTimeout((()=>{Math.random()>.2?e({success:!0,id:n.id}):t(new Error("Sync simulation failed"))}),500)})),await this.markOfflineStoryAsSynced(n.id),t.successful.push(n.id),console.log(`Story ${n.id} synced successfully`)}catch(e){console.error(`Failed to sync story ${n.id}:`,e),t.failed.push({id:n.id,error:e.message})}return console.log("Sync completed:",t),t}catch(e){return console.error("Error in syncOfflineStories:",e),{successful:[],failed:[]}}}async addFavorite(e,t){try{return await this._ensureDB(),new Promise(((n,r)=>{const s=this.db.transaction(["favorites"],"readwrite").objectStore("favorites"),o={storyId:e,...t,addedAt:(new Date).toISOString()},a=s.add(o);a.onsuccess=()=>n(),a.onerror=()=>r(a.error)}))}catch(e){throw console.error("Error adding favorite:",e),e}}async removeFavorite(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["favorites"],"readwrite").objectStore("favorites").delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)}))}catch(e){throw console.error("Error removing favorite:",e),e}}async getFavorites(){try{return await this._ensureDB(),new Promise(((e,t)=>{const n=this.db.transaction(["favorites"],"readonly").objectStore("favorites").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}))}catch(e){return console.error("Error getting favorites:",e),[]}}async isFavorite(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["favorites"],"readonly").objectStore("favorites").get(e);r.onsuccess=()=>t(!!r.result),r.onerror=()=>n(r.error)}))}catch(e){return console.error("Error checking favorite:",e),!1}}async searchStories(e){try{if(console.log("üîç IDBManager: Searching for:",e),!e||""===e.trim())return(await this.getStories()).sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));const t=await this.getStories(),n=e.toLowerCase().trim();console.log("üîç IDBManager: Total stories to search:",t.length);const r=t.filter((e=>{const t=e.name?.toLowerCase()||"",r=e.description?.toLowerCase()||"";return t.includes(n)||r.includes(n)})).sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));return console.log("üîç IDBManager: Search results:",r.length),r}catch(e){return console.error("‚ùå IDBManager: Search error:",e),[]}}async filterStories(e={}){try{console.log("üîç IDBManager: Applying filters:",e);let t=await this.getStories();if(console.log("üîç IDBManager: Total stories before filtering:",t.length),e.hasLocation&&(t=t.filter((e=>e.lat&&e.lon)),console.log("üîç IDBManager: After location filter:",t.length)),e.dateRange&&(t=t.filter((t=>{const n=new Date(t.createdAt);return n>=e.dateRange.start&&n<=e.dateRange.end})),console.log("üîç IDBManager: After date filter:",t.length)),e.favoritesOnly){const e=(await this.getFavorites()).map((e=>e.storyId));t=t.filter((t=>e.includes(t.id))),console.log("üîç IDBManager: After favorites filter:",t.length)}return t}catch(e){return console.error("Error filtering stories:",e),[]}}async sortStories(e="createdAt",t="desc",n=null){try{return console.log(`üîç IDBManager: Sorting by ${e} ${t}`),(await this.getStories()).sort(((r,s)=>{let o=r[e],a=s[e];"createdAt"===e&&(o=new Date(o),a=new Date(a));let i=0;if(i=o<a?-1:o>a?1:0,"desc"===t&&(i=-i),0===i&&n){const e=r[n.field],t=s[n.field];let o=0;return e<t?o=-1:e>t&&(o=1),"desc"===n.order?-o:o}return i}))}catch(e){return console.error("Error sorting stories:",e),[]}}async getStats(){try{const e=await this.getStories(),t=await this.getOfflineStories(),n=await this.getFavorites();return{totalStories:e.length,storiesWithLocation:e.filter((e=>e.lat&&e.lon)).length,offlineStories:t.length,unsyncedStories:t.filter((e=>!e.synced)).length,favorites:n.length}}catch(e){return console.error("Error getting stats:",e),{totalStories:0,storiesWithLocation:0,offlineStories:0,unsyncedStories:0,favorites:0}}}async getStoryById(e){try{return await this._ensureDB(),new Promise(((t,n)=>{const r=this.db.transaction(["stories"],"readonly").objectStore("stories").get(e);r.onsuccess=()=>t(r.result),r.onerror=()=>n(r.error)}))}catch(e){return console.error("Error getting story by ID:",e),null}}async getStoriesPaginated(e=1,t=10){try{const n=await this.getStories(),r=(e-1)*t,s=r+t;return{stories:n.slice(r,s),total:n.length,page:e,pageSize:t,totalPages:Math.ceil(n.length/t)}}catch(e){return console.error("Error getting paginated stories:",e),{stories:[],total:0,page:1,pageSize:10,totalPages:0}}}async clearDatabase(){try{return await this._ensureDB(),new Promise(((e,t)=>{const n=this.db.transaction(["stories","offlineStories","favorites"],"readwrite");n.objectStore("stories").clear(),n.objectStore("offlineStories").clear(),n.objectStore("favorites").clear(),n.oncomplete=()=>e(),n.onerror=()=>t(n.error)}))}catch(e){throw console.error("Error clearing database:",e),e}}}},451:(e,t,n)=>{n.r(t),n.d(t,{default:()=>o});var r=n(426),s=n(763);const o={render:async()=>s.y.isLoggedIn()?`\n      <section class="offline-page" aria-labelledby="offline-title">\n        <h1 id="offline-title" tabindex="0">üì± Mode Offline</h1>\n        \n        <div class="offline-status">\n          <div class="status-indicator ${navigator.onLine?"online":"offline"}">\n            <span class="status-dot"></span>\n            <span class="status-text">\n              ${navigator.onLine?"Anda sedang online":"Anda sedang offline"}\n            </span>\n          </div>\n        </div>\n\n        \x3c!-- Storage Info --\x3e\n        <div class="storage-info">\n          <h2>üíæ Penyimpanan Lokal</h2>\n          <div class="storage-stats">\n            <div class="stat-item">\n              <span class="stat-label">Cerita Tersimpan:</span>\n              <span class="stat-value" id="saved-stories-count">0</span>\n            </div>\n            <div class="stat-item">\n              <span class="stat-label">Cerita Offline:</span>\n              <span class="stat-value" id="offline-stories-count">0</span>\n            </div>\n            <div class="stat-item">\n              <span class="stat-label">Cerita Favorit:</span>\n              <span class="stat-value" id="favorites-count">0</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Offline Stories Section --\x3e\n        <div class="offline-section">\n          <h2>‚è≥ Cerita Menunggu Sinkronisasi</h2>\n          <div id="offline-stories-list" class="offline-stories-list">\n            <p id="no-offline-stories" style="display: none;">Tidak ada cerita offline yang menunggu sinkronisasi.</p>\n          </div>\n        </div>\n\n        \x3c!-- Cached Stories Section --\x3e\n        <div class="cached-section">\n          <h2>üìÑ Cerita yang Disimpan</h2>\n          <div class="cached-controls">\n            <button id="refresh-cache" class="secondary-button">\n              üîÑ Refresh Data\n            </button>\n            <button id="clear-cache" class="secondary-button">\n              üóëÔ∏è Hapus Cache\n            </button>\n          </div>\n          <div id="cached-stories-list" class="story-list">\n            <p id="loading-cached">Memuat cerita yang disimpan...</p>\n          </div>\n        </div>\n\n        \x3c!-- Service Worker Status --\x3e\n        <div class="sw-section">\n          <h2>‚öôÔ∏è Status Service Worker</h2>\n          <div class="sw-status">\n            <div class="sw-info">\n              <span class="info-label">Status:</span>\n              <span class="info-value" id="sw-status">Memeriksa...</span>\n            </div>\n            <div class="sw-info">\n              <span class="info-label">Cache:</span>\n              <span class="info-value" id="sw-cache">Memeriksa...</span>\n            </div>\n            <button id="update-sw" class="secondary-button" style="display: none;">\n              üîÑ Update Service Worker\n            </button>\n          </div>\n        </div>\n      </section>\n    `:'\n        <section class="offline-page">\n          <h1>Akses Ditolak</h1>\n          <p>Anda harus login untuk mengakses halaman ini.</p>\n        </section>\n      ',async afterRender(){s.y.isLoggedIn()&&(await this._loadStorageInfo(),await this._loadOfflineStories(),await this._loadCachedStories(),this._setupControls(),this._checkServiceWorker(),window.addEventListener("online",this._handleOnlineStatus.bind(this)),window.addEventListener("offline",this._handleOnlineStatus.bind(this)))},async _loadStorageInfo(){try{const[e,t,n]=await Promise.all([r.v.getStories(),r.v.getOfflineStories(),r.v.getFavorites()]),s=t.filter((e=>!e.synced));document.getElementById("saved-stories-count").textContent=e.length,document.getElementById("offline-stories-count").textContent=s.length,document.getElementById("favorites-count").textContent=n.length}catch(e){console.error("Error loading storage info:",e)}},async _loadOfflineStories(){const e=document.getElementById("offline-stories-list"),t=document.getElementById("no-offline-stories");try{const n=(await r.v.getOfflineStories()).filter((e=>!e.synced));if(0===n.length)return e.innerHTML="",void(t.style.display="block");t.style.display="none",e.innerHTML=n.map((e=>`\n        <div class="offline-story-item" data-story-id="${e.id}">\n          <div class="offline-story-content">\n            <h4>${this._extractTitle(e.description)||"Cerita Tanpa Judul"}</h4>\n            <p class="offline-story-desc">\n              ${e.description.substring(0,100)}${e.description.length>100?"...":""}\n            </p>\n            <div class="offline-story-meta">\n              <small>Dibuat: ${new Date(e.createdAt).toLocaleDateString("id-ID")}</small>\n              <small>Status: ${e.synced?"Tersinkronisasi":"Menunggu"}</small>\n            </div>\n          </div>\n          <div class="offline-story-actions">\n            <button class="sync-single-btn" data-story-id="${e.id}">\n              Sinkronisasi\n            </button>\n            <button class="delete-offline-btn" data-story-id="${e.id}">\n              Hapus\n            </button>\n          </div>\n        </div>\n      `)).join(""),this._setupOfflineStoryInteractions()}catch(t){console.error("Error loading offline stories:",t),e.innerHTML="<p>Gagal memuat cerita offline.</p>"}},async _loadCachedStories(){const e=document.getElementById("cached-stories-list"),t=document.getElementById("loading-cached");try{const n=await r.v.getStories();if(t&&t.remove(),0===n.length)return void(e.innerHTML='\n          <div style="text-align: center; padding: 40px;">\n            <p>Belum ada cerita yang disimpan secara lokal.</p>\n            <p>Buka <a href="#/beranda" class="link">Beranda</a> untuk memuat cerita.</p>\n          </div>\n        ');e.innerHTML=n.map((e=>{const t=this._extractStoryDisplayInfo(e),n=e.lat&&e.lon;return`\n          <article class="story-card cached-card">\n            <div class="story-header">\n              <h3>${t.title}</h3>\n              <span class="cached-badge">üì±</span>\n            </div>\n            \n            <img src="${e.photoUrl}"\n                 alt="Foto ilustrasi cerita ${t.title}"\n                 class="story-photo"\n                 loading="lazy"\n                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWJhciB0aWRhayB0ZXJzZWRpYTwvdGV4dD48L3N2Zz4='">\n            \n            <div class="story-content">\n              <p>${t.description}</p>\n              <div class="story-meta">\n                <small>Lokasi: ${n?`${e.lat}, ${e.lon}`:"Tidak tersedia"}</small>\n                ${t.dateInfo}\n                <small>Disimpan: ${new Date(e.cachedAt).toLocaleDateString("id-ID")}</small>\n              </div>\n            </div>\n          </article>\n        `})).join("")}catch(t){console.error("Error loading cached stories:",t),e.innerHTML="<p>Gagal memuat cerita yang disimpan.</p>"}},_setupControls(){document.getElementById("refresh-cache").addEventListener("click",(()=>this._refreshCache())),document.getElementById("clear-cache").addEventListener("click",(()=>this._clearCache())),document.getElementById("update-sw").addEventListener("click",(()=>this._updateServiceWorker()))},_setupOfflineStoryInteractions(){document.querySelectorAll(".sync-single-btn").forEach((e=>{e.addEventListener("click",(async t=>{const n=parseInt(e.dataset.storyId);await this._syncSingleStory(n)}))})),document.querySelectorAll(".delete-offline-btn").forEach((e=>{e.addEventListener("click",(async t=>{const n=parseInt(e.dataset.storyId);await this._deleteOfflineStory(n)}))}))},async _syncSingleStory(e){try{await r.v.markOfflineStoryAsSynced(e),alert("Cerita berhasil disinkronisasi!"),await this._loadStorageInfo(),await this._loadOfflineStories()}catch(e){console.error("Error syncing single story:",e),alert("Gagal menyinkronisasi cerita.")}},async _deleteOfflineStory(e){if(confirm("Apakah Anda yakin ingin menghapus cerita offline ini?"))try{await r.v.deleteOfflineStory(e),alert("Cerita offline berhasil dihapus!"),await this._loadStorageInfo(),await this._loadOfflineStories()}catch(e){console.error("Error deleting offline story:",e),alert("Gagal menghapus cerita offline.")}},async _refreshCache(){try{const e=await r.v.getStories();await Promise.all(e.map((e=>r.v.deleteStory(e.id)))),alert("Cache berhasil di-refresh. Silakan buka Beranda untuk memuat ulang data."),await this._loadStorageInfo(),await this._loadCachedStories()}catch(e){console.error("Error refreshing cache:",e),alert("Gagal me-refresh cache.")}},async _clearCache(){if(confirm("Apakah Anda yakin ingin menghapus semua data yang disimpan secara lokal?"))try{window.indexedDB&&(await r.v.init(),window.indexedDB.deleteDatabase("CeritaDatabase")),alert("Semua data lokal berhasil dihapus!"),setTimeout((()=>{window.location.reload()}),1e3)}catch(e){console.error("Error clearing cache:",e),alert("Gagal menghapus cache.")}},async _checkServiceWorker(){const e=document.getElementById("sw-status"),t=document.getElementById("sw-cache"),n=document.getElementById("update-sw");try{if("serviceWorker"in navigator){const r=await navigator.serviceWorker.ready;if(r){e.textContent="Aktif",e.style.color="#28a745";const s=(await caches.keys()).some((e=>e.includes("cerita-di-sekitarmu")));t.textContent=s?"Tersedia":"Tidak tersedia",t.style.color=s?"#28a745":"#dc3545",r.addEventListener("updatefound",(()=>{n.style.display="block"}))}else e.textContent="Tidak aktif",e.style.color="#dc3545"}else e.textContent="Tidak didukung",e.style.color="#dc3545"}catch(t){console.error("Error checking service worker:",t),e.textContent="Error",e.style.color="#dc3545"}},async _updateServiceWorker(){try{if("serviceWorker"in navigator){const e=await navigator.serviceWorker.ready;await e.update(),alert("Service Worker diperbarui! Halaman akan dimuat ulang."),window.location.reload()}}catch(e){console.error("Error updating service worker:",e),alert("Gagal memperbarui Service Worker.")}},_handleOnlineStatus(){const e=document.querySelector(".status-indicator"),t=document.querySelector(".status-text");navigator.onLine?(e.classList.remove("offline"),e.classList.add("online"),t.textContent="Anda sedang online",setTimeout((()=>{this._loadStorageInfo(),this._loadOfflineStories()}),1e3)):(e.classList.remove("online"),e.classList.add("offline"),t.textContent="Anda sedang offline")},_extractTitle(e){if(e&&e.startsWith("**")&&e.includes("**\n")){const t=e.split("**\n");if(t.length>=2)return t[0].replace("**","").trim()}return null},_extractStoryDisplayInfo(e){let t="Cerita Tanpa Judul",n=e.description;if(e.description&&e.description.startsWith("**")&&e.description.includes("**\n")){const r=e.description.split("**\n");r.length>=2&&(t=r[0].replace("**","").trim(),n=r.slice(1).join("").trim())}"Cerita Tanpa Judul"===t&&e.name&&(t=e.name);let r="";if(e.createdAt)try{r=`<small>Diposting: ${new Date(e.createdAt).toLocaleDateString("id-ID")}</small>`}catch(e){console.error("Error formatting date:",e)}return{title:t,description:n,dateInfo:r}}}}}]);