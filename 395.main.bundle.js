"use strict";(self.webpackChunkcerita_di_sekitarmu=self.webpackChunkcerita_di_sekitarmu||[]).push([[395],{188:(e,t,r)=>{r.d(t,{DY:()=>l,Lx:()=>i,ZO:()=>s,y_:()=>a});var o=r(763);const n="https://story-api.dicoding.dev/v1";async function s(){const e=o.y.getToken();if(!e)return console.log("User belum login, tidak bisa mengambil data stories"),[];try{console.log("üîç DEBUG - Fetching stories from API...");const t=new AbortController,r=setTimeout((()=>t.abort()),1e4),o=await fetch(`${n}/stories`,{headers:{Authorization:`Bearer ${e}`},signal:t.signal});if(clearTimeout(r),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const s=await o.json();return console.log("üîç DEBUG - Full API Response:",s),s.error||!s.listStory?(console.error("API returned error:",s.message),[]):s.listStory.map((e=>{let t=e.photoUrl;return e.photoUrl&&e.photoUrl.startsWith("http")||(t="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWJhciB0aWRhayB0ZXJzZWRpYTwvdGV4dD48L3N2Zz4="),{id:e.id,name:e.name,description:e.description,photoUrl:t,lat:e.lat,lon:e.lon,createdAt:e.createdAt}}))}catch(e){return console.error("‚ùå Error fetching stories:",e),"AbortError"===e.name?console.error("Request timeout - API server mungkin lambat"):"TypeError"===e.name&&e.message.includes("Failed to fetch")&&console.error("Network error - Tidak bisa connect ke API server"),[]}}async function a({description:e,photo:t,lat:r,lon:s}){const a=o.y.getToken();if(!a)return{error:!0,message:"Anda harus login untuk menambah cerita."};const i=new FormData;i.append("description",e),i.append("photo",t),r&&i.append("lat",r),s&&i.append("lon",s);try{console.log("üîç DEBUG - Mulai mengirim cerita ke API...");const e=new AbortController,t=setTimeout((()=>e.abort()),3e4),r=await fetch(`${n}/stories`,{method:"POST",body:i,headers:{Authorization:`Bearer ${a}`},signal:e.signal});clearTimeout(t),console.log("üîç DEBUG - Response status:",r.status);const o=await r.json();return console.log("üîç DEBUG - Response data:",o),!r.ok||o.error?{error:!0,message:o.message||`Error ${r.status}: ${r.statusText}`}:(console.log("üîç DEBUG - Cerita berhasil dikirim:",o),o)}catch(e){return console.error("üîç DEBUG - Error detail:",e),"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:"TypeError"===e.name&&e.message.includes("Failed to fetch")?{error:!0,message:"Gagal terhubung ke server. Periksa koneksi internet Anda."}:{error:!0,message:`Gagal mengirim data: ${e.message}`}}}async function i({email:e,password:t}){try{const r=new AbortController,o=setTimeout((()=>r.abort()),1e4),s=await fetch(`${n}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t}),signal:r.signal});clearTimeout(o);const a=await s.json();return s.ok?{error:!1,data:a}:{error:!0,message:a.message||"Login gagal"}}catch(e){return"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:{error:!0,message:"Terjadi kesalahan jaringan"}}}async function l({name:e,email:t,password:r}){try{const o=new AbortController,s=setTimeout((()=>o.abort()),1e4),a=await fetch(`${n}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:r}),signal:o.signal});clearTimeout(s);const i=await a.json();return a.ok?{error:!1,data:i}:{error:!0,message:i.message||"Pendaftaran gagal"}}catch(e){return"AbortError"===e.name?{error:!0,message:"Request timeout - Server terlalu lama merespon."}:{error:!0,message:"Terjadi kesalahan jaringan"}}}},395:(e,t,r)=>{r.r(t),r.d(t,{default:()=>a});var o=r(188),n=r(763),s=r(426);const a={_map:null,_markers:[],_stories:[],_filteredStories:[],_currentFilter:"all",_currentSort:"newest",_searchQuery:"",render:async()=>n.y.isLoggedIn()?'\n      <section class="home-page" aria-labelledby="home-title">\n        \n        \x3c!-- Controls Section --\x3e\n        <div class="story-controls">\n          <div class="search-box">\n            <input type="text" id="story-search" placeholder="Cari cerita..." \n                   aria-label="Cari cerita berdasarkan judul atau deskripsi">\n            <button id="search-button" aria-label="Cari">üîç</button>\n          </div>\n          \n          <div class="filter-controls">\n            <select id="location-filter" aria-label="Filter berdasarkan lokasi">\n              <option value="all">Semua Cerita</option>\n              <option value="with-location">Dengan Lokasi</option>\n              <option value="without-location">Tanpa Lokasi</option>\n            </select>\n            \n            <select id="sort-by" aria-label="Urutkan cerita">\n              <option value="newest">Terbaru</option>\n              <option value="oldest">Terlama</option>\n            </select>\n\n            <button id="toggle-favorites-view" class="secondary-button" aria-label="Lihat favorit">\n              ‚ù§Ô∏è Favorit\n            </button>\n\n            <button id="sync-offline-data" class="secondary-button" aria-label="Sinkronisasi data offline">\n              üîÑ Sync\n            </button>\n          </div>\n        </div>\n\n        <div id="map-container">\n          <div id="map" style="height: 400px; margin-bottom: 24px; border-radius: 8px; border: 1px solid #ddd;"\n               aria-label="Peta interaktif menampilkan lokasi cerita"></div>\n        </div>\n        \n        <div id="story-stats" class="story-stats" aria-live="polite"></div>\n        \n        <div id="story-list" class="story-list">\n          <p id="loading-message">Memuat cerita...</p>\n        </div>\n\n        \x3c!-- Offline Stories Section --\x3e\n        <div id="offline-stories-section" style="display: none;">\n          <h2>üì± Cerita Offline</h2>\n          <div id="offline-stories-list"></div>\n        </div>\n      </section>\n    ':'\n        <section class="home-page" aria-labelledby="home-title">\n          <h1 id="home-title" tabindex="0">Akses Ditolak</h1>\n          <div style="text-align: center; padding: 40px;">\n            <p>Anda harus login untuk mengakses halaman ini.</p>\n            <a href="#/login" class="link">Masuk</a> atau\n            <a href="#/register" class="link">Daftar akun baru</a>\n          </div>\n        </section>\n      ',async afterRender(){n.y.isLoggedIn()&&(console.log("HomePage: afterRender started"),await new Promise((e=>setTimeout(e,100))),await this._initializeMap(),await this._loadStories(),this._setupControls(),this._checkOfflineStories(),console.log("HomePage: afterRender completed"))},async _initializeMap(){console.log("HomePage: Initializing map..."),await new Promise((e=>setTimeout(e,50)));const e=document.querySelector("#map");if(!(console.log("HomePage: Map container:",e),e||(console.error("HomePage: Map container not found, retrying..."),await new Promise((e=>setTimeout(e,200))),document.querySelector("#map"))))throw new Error("Map container not found after retry");try{if("undefined"==typeof L)throw console.error("Leaflet not loaded"),new Error("Leaflet library not found. Please check if Leaflet CDN is loaded.");return this._map&&(this._map.remove(),this._map=null),0===e.offsetHeight&&(e.style.height="400px"),console.log("HomePage: Creating Leaflet map..."),this._map=L.map("map").setView([-2.5,118],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:18,minZoom:3}).addTo(this._map),delete L.Icon.Default.prototype._getIconUrl,L.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png"}),L.Marker.prototype.options.icon=L.icon({iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),this._map.on("tileerror",(e=>{console.error("Map tile error:",e)})),this._map.whenReady((()=>{console.log("HomePage: Map is ready")})),console.log("HomePage: Map initialized successfully"),this._map}catch(e){console.error("Error initializing map:",e);const t=document.querySelector("#map-container");throw t&&(t.innerHTML=`\n          <div style="text-align: center; padding: 40px; color: #666; background: #f5f5f5; border-radius: 8px;">\n            <p style="margin-bottom: 15px;">Tidak dapat memuat peta</p>\n            <p style="margin-bottom: 20px; font-size: 14px;">Error: ${e.message}</p>\n            <button onclick="window.location.reload()" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">\n              Refresh Halaman\n            </button>\n          </div>\n        `),e}},async _loadStories(){console.log("HomePage: Loading stories...");const e=document.querySelector("#story-list"),t=document.querySelector("#loading-message");try{let e=await(0,o.ZO)();e&&e.length>0?(console.log(`‚úÖ Successfully loaded ${e.length} stories from API`),await s.v.saveStories(e),this._stories=e):(console.log("‚ö†Ô∏è No stories from API, loading from IndexedDB..."),this._stories=await s.v.getStories()),t&&t.remove(),this._displayStories(),this._updateStats()}catch(r){console.error("‚ùå Error loading stories:",r);try{this._stories=await s.v.getStories(),this._displayStories(),this._updateStats(),t&&t.remove(),e.innerHTML+='\n        <div class="offline-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">\n          <p style="margin: 0; color: #856404;">\n            ‚ö†Ô∏è <strong>Anda sedang offline atau server tidak tersedia.</strong><br>\n            Menampilkan data yang tersimpan secara offline.\n          </p>\n        </div>\n      '}catch(e){console.error("‚ùå Error loading from IndexedDB:",e),this._showError("Gagal memuat cerita. Periksa koneksi internet Anda.")}}},_setupControls(){console.log("HomePage: Setting up controls...");const e=document.getElementById("story-search"),t=document.getElementById("search-button"),r=()=>{this._searchQuery=e.value.trim(),this._applyFilters()};e&&t&&(e.addEventListener("input",r),t.addEventListener("click",r),e.addEventListener("keypress",(e=>{"Enter"===e.key&&r()})));const o=document.getElementById("location-filter"),n=document.getElementById("sort-by");o&&o.addEventListener("change",(e=>{this._currentFilter=e.target.value,this._applyFilters()})),n&&n.addEventListener("change",(e=>{this._currentSort=e.target.value,this._applyFilters()}));const s=document.getElementById("toggle-favorites-view");s&&s.addEventListener("click",(()=>this._showFavorites()));const a=document.getElementById("sync-offline-data");a&&a.addEventListener("click",(()=>this._syncOfflineData()))},async _applyFilters(){let e=[...this._stories];this._searchQuery&&(e=await s.v.searchStories(this._searchQuery)),"with-location"===this._currentFilter?e=e.filter((e=>e.lat&&e.lon)):"without-location"===this._currentFilter&&(e=e.filter((e=>!e.lat||!e.lon)));const t="newest"===this._currentSort?"desc":"asc";e=await s.v.sortStories("createdAt",t),this._filteredStories=e,this._displayStories(),this._updateStats()},async _displayStories(){const e=document.querySelector("#story-list"),t=this._filteredStories.length>0?this._filteredStories:this._stories;if(!t||0===t.length)return void(e.innerHTML='\n        <div style="text-align: center; padding: 40px;">\n          <p>Belum ada cerita yang tersedia.</p>\n          <p>Jadilah yang pertama untuk <a href="#/add" class="link">berbagi cerita</a>!</p>\n        </div>\n      ');const r=await Promise.all(t.map((async(e,t)=>{const r=this._extractStoryDisplayInfo(e),o=await s.v.isFavorite(e.id);return this._createStoryCard(e,r,t,o)})));e.innerHTML=r.join(""),this._setupStoryInteractivity(),this._updateMapMarkers(t)},_createStoryCard(e,t,r,o){const n=e.lat&&e.lon;return`\n      <article class="story-card" data-index="${r}" data-story-id="${e.id}"\n               data-has-coordinates="${n}"\n               aria-label="Cerita: ${t.title}">\n        <div class="story-header">\n          <h3>${t.title}</h3>\n          <button class="favorite-btn ${o?"favorited":""}" \n                  data-story-id="${e.id}"\n                  aria-label="${o?"Hapus dari favorit":"Tambahkan ke favorit"}">\n            ${o?"‚ù§Ô∏è":"ü§ç"}\n          </button>\n        </div>\n        \n        <img src="${e.photoUrl}"\n             alt="Foto ilustrasi cerita ${t.title}"\n             class="story-photo"\n             loading="lazy"\n             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkdhbWJhciB0aWRhayB0ZXJzZWRpYTwvdGV4dD48L3N2Zz4='">\n        \n        <div class="story-content">\n          <p>${t.description}</p>\n          <div class="story-meta">\n            <small>Lokasi: ${n?`${e.lat}, ${e.lon}`:"Tidak tersedia"}</small>\n            ${t.dateInfo}\n          </div>\n        </div>\n        \n        <div class="story-actions">\n          <button class="action-btn share-btn" data-story-id="${e.id}">\n            üîó Bagikan\n          </button>\n          ${n?`\n            <button class="action-btn map-btn" data-story-id="${e.id}">\n              üó∫Ô∏è Lihat di Peta\n            </button>\n          `:""}\n        </div>\n      </article>\n    `},_setupStoryInteractivity(){document.querySelectorAll(".favorite-btn").forEach((e=>{e.addEventListener("click",(async t=>{t.stopPropagation();const r=e.dataset.storyId,o=this._stories.find((e=>e.id===r));e.classList.contains("favorited")?(await s.v.removeFavorite(r),e.classList.remove("favorited"),e.innerHTML="ü§ç",e.setAttribute("aria-label","Tambahkan ke favorit")):(await s.v.addFavorite(r,o),e.classList.add("favorited"),e.innerHTML="‚ù§Ô∏è",e.setAttribute("aria-label","Hapus dari favorit"))}))})),document.querySelectorAll(".action-btn").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const r=e.dataset.storyId;e.classList.contains("share-btn")?this._shareStory(r):e.classList.contains("map-btn")&&this._focusOnStoryMap(r)}))})),document.querySelectorAll('.story-card[data-has-coordinates="true"]').forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.storyId;this._focusOnStoryMap(t)}))}))},async _showFavorites(){const e=await s.v.getFavorites();0!==e.length?(this._filteredStories=e,this._displayStories(),this._updateStats("favorit")):alert("Belum ada cerita favorit.")},async _syncOfflineData(){try{console.log("üîÑ Starting offline data sync...");const e=document.getElementById("sync-offline-data");e&&(e.disabled=!0,e.textContent="Menyinkronisasi..."),console.log("üìä Getting unsynced stories...");const t=await s.v.getUnsyncedStories();if(console.log("üìä Unsynced stories result:",t),0===t.length)return console.log("‚ÑπÔ∏è No stories to sync"),alert("Tidak ada data offline yang perlu disinkronisasi."),void(e&&(e.disabled=!1,e.textContent="üîÑ Sync"));console.log(`üîÑ Found ${t.length} stories to sync`);const r=await s.v.syncOfflineStories();console.log("üîÑ Sync results:",r),e&&(e.disabled=!1,e.textContent="üîÑ Sync"),r.successful.length>0?(alert(`Berhasil menyinkronisasi ${r.successful.length} cerita offline.`),this._loadStories(),this._checkOfflineStories()):r.failed.length>0?alert(`Gagal menyinkronisasi ${r.failed.length} cerita. Silakan coba lagi.`):alert("Tidak ada cerita yang perlu disinkronisasi.")}catch(e){console.error("‚ùå Error syncing offline data:",e);const t=document.getElementById("sync-offline-data");t&&(t.disabled=!1,t.textContent="üîÑ Sync"),alert("Gagal menyinkronisasi data offline: "+e.message)}},async _checkOfflineStories(){try{const e=(await s.v.getOfflineStories()).filter((e=>!e.synced)),t=document.getElementById("offline-stories-section"),r=document.getElementById("offline-stories-list");t&&r&&(e.length>0?(t.style.display="block",r.innerHTML=e.map((e=>`\n              <div class="offline-story-item">\n                <div class="offline-story-content">\n                  <h4>${e.name||"Cerita Tanpa Judul"}</h4>\n                  <p class="offline-story-desc">${e.description.substring(0,50)}...</p>\n                  <div class="offline-story-meta">\n                    <small>Dibuat: ${new Date(e.createdAt).toLocaleDateString("id-ID")}</small>\n                    <small>Status: ${e.synced?"Tersinkronisasi":"Belum Sync"}</small>\n                  </div>\n                </div>\n                <div class="offline-story-actions">\n                  ${e.synced?"":`\n                    <button class="sync-single-btn" data-story-id="${e.id}">\n                      Sinkronisasi\n                    </button>\n                  `}\n                  <button class="delete-offline-btn" data-story-id="${e.id}">\n                    Hapus\n                  </button>\n                </div>\n              </div>\n            `)).join(""),document.querySelectorAll(".sync-single-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=parseInt(e.target.dataset.storyId);await this._syncSingleStory(t)}))})),document.querySelectorAll(".delete-offline-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=parseInt(e.target.dataset.storyId);confirm("Apakah Anda yakin ingin menghapus cerita ini?")&&(await s.v.deleteOfflineStory(t),this._checkOfflineStories())}))}))):t.style.display="none")}catch(e){console.error("Error checking offline stories:",e)}},async _syncSingleStory(e){try{if(!(await s.v.getOfflineStories()).find((t=>t.id===e)))return void alert("Cerita tidak ditemukan.");const t=document.querySelector(`.sync-single-btn[data-story-id="${e}"]`);t&&(t.disabled=!0,t.textContent="Menyinkronisasi..."),await new Promise((e=>setTimeout(e,1e3))),await s.v.markOfflineStoryAsSynced(e),t&&(t.disabled=!1,t.textContent="Sinkronisasi"),alert("Cerita berhasil disinkronisasi!"),this._checkOfflineStories()}catch(t){console.error("Error syncing single story:",t),alert("Gagal menyinkronisasi cerita: "+t.message);const r=document.querySelector(`.sync-single-btn[data-story-id="${e}"]`);r&&(r.disabled=!1,r.textContent="Sinkronisasi")}},_updateStats(e="all"){const t=document.getElementById("story-stats");if(!t)return;const r="favorit"===e?this._filteredStories.length:this._stories.length,o=this._filteredStories.length;let n=`Menampilkan ${o} dari ${r} cerita`;this._searchQuery&&(n+=` untuk "${this._searchQuery}"`),"favorit"===e&&(n=`Menampilkan ${o} cerita favorit`),t.textContent=n},_extractStoryDisplayInfo(e){let t="Cerita Tanpa Judul",r=e.description;if(e.description&&e.description.startsWith("**")&&e.description.includes("**\n")){const o=e.description.split("**\n");o.length>=2&&(t=o[0].replace("**","").trim(),r=o.slice(1).join("").trim())}"Cerita Tanpa Judul"===t&&e.name&&(t=e.name);let o="";if(e.createdAt)try{o=`<small>Diposting: ${new Date(e.createdAt).toLocaleDateString("id-ID")}</small>`}catch(e){console.error("Error formatting date:",e)}return{title:t,description:r,dateInfo:o}},_shareStory(e){const t=this._stories.find((t=>t.id===e));if(t&&navigator.share){const e=this._extractStoryDisplayInfo(t);navigator.share({title:e.title,text:e.description,url:window.location.href})}else alert("Fitur share tidak didukung di browser ini")},_focusOnStoryMap(e){const t=this._stories.find((t=>t.id===e));if(t&&t.lat&&t.lon&&this._map){const r=this._markers.find((t=>t.storyId===e));r&&(r.marker.openPopup(),this._map.setView([t.lat,t.lon],12))}},_showError(e){const t=document.querySelector("#story-list");if(!t)return;t.innerHTML=`\n      <div style="text-align: center; padding: 40px; color: #666;">\n        <p>${e}</p>\n        <button id="retry-stories" style="margin-top: 15px; padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">\n          Coba Lagi\n        </button>\n      </div>\n    `;const r=document.getElementById("retry-stories");r&&r.addEventListener("click",(()=>{this._loadStories()}))},_updateMapMarkers(e){if(this._markers.forEach((e=>{e.marker&&this._map&&this._map.removeLayer(e.marker)})),this._markers=[],e.forEach((e=>{if(e.lat&&e.lon&&this._map)try{const t=this._extractStoryDisplayInfo(e),r=L.marker([parseFloat(e.lat),parseFloat(e.lon)]).addTo(this._map);r.bindPopup(`\n            <div style="max-width: 200px;">\n              <strong>${t.title}</strong><br>\n              <img src="${e.photoUrl}" alt="${t.title}" style="width:100%;height:auto;margin:5px 0;border-radius:4px;">\n              <p style="margin:8px 0;">${t.description.substring(0,100)}${t.description.length>100?"...":""}</p>\n              <small style="color:#666;">Lokasi: ${e.lat}, ${e.lon}</small>\n            </div>\n          `),this._markers.push({storyId:e.id,marker:r})}catch(t){console.error(`Error adding marker for story ${e.id}:`,t)}})),this._markers.length>0&&this._map){const e=new L.featureGroup(this._markers.map((e=>e.marker)));this._map.fitBounds(e.getBounds().pad(.1))}},cleanup(){console.log("HomePage: Cleaning up..."),this._map&&(this._map.remove(),this._map=null),this._markers.forEach((e=>{e.marker&&e.marker.remove()})),this._markers=[],this._stories=[],this._filteredStories=[]}}},426:(e,t,r)=>{r.d(t,{v:()=>o});const o=new class{constructor(){this.dbName="CeritaDatabase",this.version=9,this.db=null,this._isOpening=!1,this._openPromise=null}async init(){return this._isOpening||(this._isOpening=!0,this._openPromise=new Promise(((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>{this._isOpening=!1,t(r.error)},r.onsuccess=()=>{this.db=r.result,this._isOpening=!1,this.db.onerror=e=>{console.error("Database error:",e.target.error)},this.db.onclose=()=>{console.log("Database connection closed"),this.db=null,this._isOpening=!1},e(this.db)},r.onupgradeneeded=e=>{const t=e.target.result,r=e.oldVersion;if(console.log(`üîÑ Database upgrading from version ${r} to ${this.version}`),r<1){const e=t.createObjectStore("stories",{keyPath:"id"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("hasLocation","hasLocation",{unique:!1}),e.createIndex("name","name",{unique:!1}),e.createIndex("description","description",{unique:!1});const r=t.createObjectStore("offlineStories",{keyPath:"id",autoIncrement:!0});r.createIndex("createdAt","createdAt",{unique:!1}),r.createIndex("synced","synced",{unique:!1}),t.createObjectStore("favorites",{keyPath:"storyId"}).createIndex("addedAt","addedAt",{unique:!1})}if(r<9){const t=e.target.transaction.objectStore("offlineStories");t.indexNames.contains("synced")||t.createIndex("synced","synced",{unique:!1})}},r.onblocked=()=>{console.log("‚ö†Ô∏è Database upgrade blocked - close other tabs"),this.db&&this.db.close()}}))),this._openPromise}async _ensureDB(){if(this.db)try{const e=this.db.transaction([],"readonly");await new Promise(((t,r)=>{e.oncomplete=t,e.onerror=r}))}catch(e){console.log("Database connection lost, reinitializing..."),this.db=null,await this.init()}else await this.init()}async saveStories(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["stories"],"readwrite"),n=o.objectStore("stories");n.clear(),e.forEach((e=>{n.put({...e,hasLocation:!(!e.lat||!e.lon),cachedAt:(new Date).toISOString()})})),o.oncomplete=()=>t(),o.onerror=()=>r(o.error)}))}catch(e){throw console.error("Error saving stories:",e),e}}async getStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const r=this.db.transaction(["stories"],"readonly").objectStore("stories").getAll();r.onsuccess=()=>e(r.result||[]),r.onerror=()=>t(r.error)}))}catch(e){return console.error("Error getting stories:",e),[]}}async deleteStory(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["stories"],"readwrite").objectStore("stories").delete(e);o.onsuccess=()=>t(),o.onerror=()=>r(o.error)}))}catch(e){throw console.error("Error deleting story:",e),e}}async saveOfflineStory(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories"),n={...e,id:Date.now(),createdAt:(new Date).toISOString(),synced:!1},s=o.add(n);s.onsuccess=()=>t(n.id),s.onerror=()=>r(s.error)}))}catch(e){throw console.error("Error saving offline story:",e),e}}async getOfflineStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const r=this.db.transaction(["offlineStories"],"readonly").objectStore("offlineStories").getAll();r.onsuccess=()=>e(r.result||[]),r.onerror=()=>t(r.error)}))}catch(e){return console.error("Error getting offline stories:",e),[]}}async deleteOfflineStory(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories").delete(e);o.onsuccess=()=>t(),o.onerror=()=>r(o.error)}))}catch(e){throw console.error("Error deleting offline story:",e),e}}async markOfflineStoryAsSynced(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["offlineStories"],"readwrite").objectStore("offlineStories"),n=o.get(e);n.onsuccess=()=>{const s=n.result;if(s){const n="string"==typeof e?parseInt(e):e;s.synced=!0,s.id=n;const a=o.put(s);a.onsuccess=()=>{console.log(`Story ${e} marked as synced`),t()},a.onerror=t=>{console.error(`Error marking story ${e} as synced:`,t),r(t)}}else console.warn(`Story ${e} not found for marking as synced`),t()},n.onerror=t=>{console.error(`Error getting story ${e}:`,t),r(t)}}))}catch(e){throw console.error("Error marking story as synced:",e),e}}async getUnsyncedStories(){try{return await this._ensureDB(),new Promise(((e,t)=>{const r=this.db.transaction(["offlineStories"],"readonly").objectStore("offlineStories").getAll();r.onsuccess=()=>{try{const t=r.result||[];console.log("Total offline stories:",t.length);const o=t.filter((e=>!1===e.synced||void 0===e.synced));console.log("Unsynced stories:",o.length),e(o)}catch(t){console.error("Error filtering stories:",t),e([])}},r.onerror=e=>{console.error("Error getting offline stories:",e),t(e)}}))}catch(e){return console.error("Error in getUnsyncedStories:",e),[]}}async syncOfflineStories(){try{console.log("Starting offline stories sync...");const e=await this.getUnsyncedStories();console.log(`Found ${e.length} stories to sync`);const t={successful:[],failed:[]};if(0===e.length)return console.log("No stories to sync"),t;for(const r of e)try{console.log(`Syncing story ${r.id}...`),await new Promise(((e,t)=>{setTimeout((()=>{Math.random()>.2?e({success:!0,id:r.id}):t(new Error("Sync simulation failed"))}),500)})),await this.markOfflineStoryAsSynced(r.id),t.successful.push(r.id),console.log(`Story ${r.id} synced successfully`)}catch(e){console.error(`Failed to sync story ${r.id}:`,e),t.failed.push({id:r.id,error:e.message})}return console.log("Sync completed:",t),t}catch(e){return console.error("Error in syncOfflineStories:",e),{successful:[],failed:[]}}}async addFavorite(e,t){try{return await this._ensureDB(),new Promise(((r,o)=>{const n=this.db.transaction(["favorites"],"readwrite").objectStore("favorites"),s={storyId:e,...t,addedAt:(new Date).toISOString()},a=n.add(s);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)}))}catch(e){throw console.error("Error adding favorite:",e),e}}async removeFavorite(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["favorites"],"readwrite").objectStore("favorites").delete(e);o.onsuccess=()=>t(),o.onerror=()=>r(o.error)}))}catch(e){throw console.error("Error removing favorite:",e),e}}async getFavorites(){try{return await this._ensureDB(),new Promise(((e,t)=>{const r=this.db.transaction(["favorites"],"readonly").objectStore("favorites").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}))}catch(e){return console.error("Error getting favorites:",e),[]}}async isFavorite(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["favorites"],"readonly").objectStore("favorites").get(e);o.onsuccess=()=>t(!!o.result),o.onerror=()=>r(o.error)}))}catch(e){return console.error("Error checking favorite:",e),!1}}async searchStories(e){try{if(console.log("üîç IDBManager: Searching for:",e),!e||""===e.trim())return(await this.getStories()).sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));const t=await this.getStories(),r=e.toLowerCase().trim();console.log("üîç IDBManager: Total stories to search:",t.length);const o=t.filter((e=>{const t=e.name?.toLowerCase()||"",o=e.description?.toLowerCase()||"";return t.includes(r)||o.includes(r)})).sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));return console.log("üîç IDBManager: Search results:",o.length),o}catch(e){return console.error("‚ùå IDBManager: Search error:",e),[]}}async filterStories(e={}){try{console.log("üîç IDBManager: Applying filters:",e);let t=await this.getStories();if(console.log("üîç IDBManager: Total stories before filtering:",t.length),e.hasLocation&&(t=t.filter((e=>e.lat&&e.lon)),console.log("üîç IDBManager: After location filter:",t.length)),e.dateRange&&(t=t.filter((t=>{const r=new Date(t.createdAt);return r>=e.dateRange.start&&r<=e.dateRange.end})),console.log("üîç IDBManager: After date filter:",t.length)),e.favoritesOnly){const e=(await this.getFavorites()).map((e=>e.storyId));t=t.filter((t=>e.includes(t.id))),console.log("üîç IDBManager: After favorites filter:",t.length)}return t}catch(e){return console.error("Error filtering stories:",e),[]}}async sortStories(e="createdAt",t="desc",r=null){try{return console.log(`üîç IDBManager: Sorting by ${e} ${t}`),(await this.getStories()).sort(((o,n)=>{let s=o[e],a=n[e];"createdAt"===e&&(s=new Date(s),a=new Date(a));let i=0;if(i=s<a?-1:s>a?1:0,"desc"===t&&(i=-i),0===i&&r){const e=o[r.field],t=n[r.field];let s=0;return e<t?s=-1:e>t&&(s=1),"desc"===r.order?-s:s}return i}))}catch(e){return console.error("Error sorting stories:",e),[]}}async getStats(){try{const e=await this.getStories(),t=await this.getOfflineStories(),r=await this.getFavorites();return{totalStories:e.length,storiesWithLocation:e.filter((e=>e.lat&&e.lon)).length,offlineStories:t.length,unsyncedStories:t.filter((e=>!e.synced)).length,favorites:r.length}}catch(e){return console.error("Error getting stats:",e),{totalStories:0,storiesWithLocation:0,offlineStories:0,unsyncedStories:0,favorites:0}}}async getStoryById(e){try{return await this._ensureDB(),new Promise(((t,r)=>{const o=this.db.transaction(["stories"],"readonly").objectStore("stories").get(e);o.onsuccess=()=>t(o.result),o.onerror=()=>r(o.error)}))}catch(e){return console.error("Error getting story by ID:",e),null}}async getStoriesPaginated(e=1,t=10){try{const r=await this.getStories(),o=(e-1)*t,n=o+t;return{stories:r.slice(o,n),total:r.length,page:e,pageSize:t,totalPages:Math.ceil(r.length/t)}}catch(e){return console.error("Error getting paginated stories:",e),{stories:[],total:0,page:1,pageSize:10,totalPages:0}}}async clearDatabase(){try{return await this._ensureDB(),new Promise(((e,t)=>{const r=this.db.transaction(["stories","offlineStories","favorites"],"readwrite");r.objectStore("stories").clear(),r.objectStore("offlineStories").clear(),r.objectStore("favorites").clear(),r.oncomplete=()=>e(),r.onerror=()=>t(r.error)}))}catch(e){throw console.error("Error clearing database:",e),e}}}}}]);